{% extends "base.html" %}

{% block title %}Dashboard - Life Organizer{% endblock %}

{% block content %}
<div class="row">
    <!-- Welcome Section -->
    <div class="col-12">
        <div class="health-card">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-3">
                        <i class="fas fa-sun me-2"></i>¡Hola {{ user.name }}!
                    </h2>
                    <p class="mb-0">Cuidemos tu salud hoy. Aquí tienes un resumen de tu día:</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex justify-content-end align-items-center">
                        <div class="me-3">
                            <small class="text-white-50">Salud Score</small>
                            <div class="h4 mb-0">{{ health_score or 85 }}</div>
                        </div>
                        <i class="fas fa-shield-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Health Stats Cards -->
<div class="row mt-4">
    <div class="col-md-3 col-6 mb-3">
        <div class="stat-card">
            <i class="fas fa-tint stat-icon text-primary"></i>
            <div class="h4 mb-1">{{ health_data.water_intake if health_data else 0 }}</div>
            <div class="text-muted">ml de agua</div>
            <div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar bg-primary" style="width: {{ ((health_data.water_intake / health_data.water_target * 100) if health_data and health_data.water_target and health_data.water_target > 0 else 0) }}%"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-6 mb-3">
        <div class="stat-card">
            <i class="fas fa-heartbeat stat-icon text-danger"></i>
            <div class="h4 mb-1">{{ health_data.systolic_pressure if health_data else '--' }}</div>
            <div class="text-muted">Presión Sistólica</div>
            <small class="text-muted">{{ health_data.diastolic_pressure if health_data else '--' }} diastólica</small>
        </div>
    </div>
    
    <div class="col-md-3 col-6 mb-3">
        <div class="stat-card">
            <i class="fas fa-dumbbell stat-icon text-success"></i>
            <div class="h4 mb-1">{{ health_data.exercise_minutes if health_data else 0 }}</div>
            <div class="text-muted">Min. Ejercicio</div>
            <small class="text-muted">Meta: 30 min</small>
        </div>
    </div>
    
    <div class="col-md-3 col-6 mb-3">
        <div class="stat-card">
            <i class="fas fa-weight stat-icon text-warning"></i>
            <div class="h4 mb-1">{{ health_data.weight if health_data else '--' }}</div>
            <div class="text-muted">Peso (kg)</div>
            <small class="text-muted">Último registro</small>
        </div>
    </div>
</div>

<!-- Health Alerts -->
{% if health_alerts %}
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-warning alert-custom">
            <h5 class="alert-heading">
                <i class="fas fa-exclamation-triangle me-2"></i>Alertas de Salud
            </h5>
            {% for alert in health_alerts %}
            <div class="mb-2">
                <strong>{{ alert.message }}</strong>
                {% if alert.action_recommended %}
                <br><small>{{ alert.action_recommended }}</small>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Acciones Rápidas
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2 col-4 mb-3">
                        <button class="btn btn-outline-primary w-100" onclick="addWater(250)">
                            <i class="fas fa-tint mb-2 d-block"></i>
                            <small>Agua<br>250ml</small>
                        </button>
                    </div>
                    <div class="col-md-2 col-4 mb-3">
                        <button class="btn btn-outline-success w-100" onclick="toggleMeal('breakfast')">
                            <i class="fas fa-coffee mb-2 d-block"></i>
                            <small>Desayuno</small>
                        </button>
                    </div>
                    <div class="col-md-2 col-4 mb-3">
                        <button class="btn btn-outline-warning w-100" onclick="toggleMeal('lunch')">
                            <i class="fas fa-hamburger mb-2 d-block"></i>
                            <small>Almuerzo</small>
                        </button>
                    </div>
                    <div class="col-md-2 col-4 mb-3">
                        <button class="btn btn-outline-info w-100" onclick="toggleMeal('dinner')">
                            <i class="fas fa-utensils mb-2 d-block"></i>
                            <small>Cena</small>
                        </button>
                    </div>
                    <div class="col-md-2 col-4 mb-3">
                        <button class="btn btn-outline-danger w-100" onclick="showBloodPressureModal()">
                            <i class="fas fa-heartbeat mb-2 d-block"></i>
                            <small>Presión</small>
                        </button>
                    </div>
                    <div class="col-md-2 col-4 mb-3">
                        <button class="btn btn-outline-secondary w-100" onclick="showWeightModal()">
                            <i class="fas fa-weight mb-2 d-block"></i>
                            <small>Peso</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Today's Tasks -->
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-tasks me-2"></i>Tareas de Hoy
                </h5>
                <button class="btn btn-primary btn-sm" onclick="showAddTaskModal()">
                    <i class="fas fa-plus me-1"></i>Nueva Tarea
                </button>
            </div>
            <div class="card-body">
                {% if tasks %}
                    {% for task in tasks %}
                    <div class="task-item {% if task.completed %}task-completed{% endif %}">
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm me-3" onclick="toggleTask({{ task.id }})">
                                <i class="fas fa-check text-success" {% if not task.completed %}style="display: none;"{% endif %}></i>
                                <i class="fas fa-circle text-muted" {% if task.completed %}style="display: none;"{% endif %}></i>
                            </button>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ task.title }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>{{ task.due_time or 'Sin hora' }}
                                    <span class="badge bg-secondary ms-2">{{ task.category }}</span>
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-clipboard-list fa-3x mb-3 opacity-50"></i>
                        <p>No tienes tareas para hoy</p>
                        <button class="btn btn-primary" onclick="showAddTaskModal()">
                            <i class="fas fa-plus me-1"></i>Agregar Primera Tarea
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Notifications -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bell me-2"></i>Notificaciones
                    {% if notifications %}
                    <span class="badge bg-danger ms-2">{{ notifications|length }}</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if notifications %}
                    {% for notification in notifications %}
                    <div class="alert alert-{{ 'danger' if notification.priority == 'urgent' else 'info' }} alert-sm mb-2">
                        <small>{{ notification.message }}</small>
                        <br><small class="text-muted">{{ notification.created_at.strftime('%H:%M') }}</small>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-3 text-muted">
                        <i class="fas fa-bell-slash fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">No hay notificaciones</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Blood Pressure Modal -->
<div class="modal fade" id="bloodPressureModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-heartbeat me-2"></i>Registrar Presión Arterial
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">Sistólica</label>
                        <input type="number" class="form-control" id="systolicInput" placeholder="120">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Diastólica</label>
                        <input type="number" class="form-control" id="diastolicInput" placeholder="80">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveBloodPressure()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Weight Modal -->
<div class="modal fade" id="weightModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-weight me-2"></i>Registrar Peso
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Peso (kg)</label>
                    <input type="number" class="form-control" id="weightInput" placeholder="70.0" step="0.1">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveWeight()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Nueva Tarea
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Título</label>
                    <input type="text" class="form-control" id="taskTitle" placeholder="Ej. Tomar medicamento">
                </div>
                <div class="mb-3">
                    <label class="form-label">Categoría</label>
                    <select class="form-select" id="taskCategory">
                        <option value="personal">Personal</option>
                        <option value="work">Trabajo</option>
                        <option value="exercise">Ejercicio</option>
                        <option value="food">Alimentación</option>
                        <option value="health">Salud</option>
                    </select>
                </div>
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">Hora</label>
                        <input type="time" class="form-control" id="taskTime">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Prioridad</label>
                        <select class="form-select" id="taskPriority">
                            <option value="low">Baja</option>
                            <option value="medium" selected>Media</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">Crear Tarea</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Funciones para interactuar con la API
async function addWater(amount) {
    try {
        const response = await makeRequest('/api/health/water', {
            method: 'POST',
            body: JSON.stringify({ amount: amount })
        });
        
        if (response.success) {
            showToast(`Agregados ${amount}ml de agua`, 'success');
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        console.error('Error adding water:', error);
    }
}

async function toggleMeal(mealType) {
    try {
        const response = await makeRequest('/api/health/meal', {
            method: 'POST',
            body: JSON.stringify({ meal_type: mealType })
        });
        
        if (response.success) {
            showToast(`${mealType} registrado`, 'success');
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        console.error('Error toggling meal:', error);
    }
}

async function saveBloodPressure() {
    const systolic = document.getElementById('systolicInput').value;
    const diastolic = document.getElementById('diastolicInput').value;
    
    if (!systolic || !diastolic) {
        showToast('Por favor completa ambos valores', 'warning');
        return;
    }
    
    try {
        const response = await makeRequest('/api/health/blood-pressure', {
            method: 'POST',
            body: JSON.stringify({ 
                systolic: parseInt(systolic), 
                diastolic: parseInt(diastolic) 
            })
        });
        
        if (response.success) {
            showToast('Presión arterial registrada', 'success');
            bootstrap.Modal.getInstance(document.getElementById('bloodPressureModal')).hide();
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        console.error('Error saving blood pressure:', error);
    }
}

async function saveWeight() {
    const weight = document.getElementById('weightInput').value;
    
    if (!weight) {
        showToast('Por favor ingresa tu peso', 'warning');
        return;
    }
    
    try {
        const response = await makeRequest('/api/health/weight', {
            method: 'POST',
            body: JSON.stringify({ weight: parseFloat(weight) })
        });
        
        if (response.success) {
            showToast('Peso registrado', 'success');
            bootstrap.Modal.getInstance(document.getElementById('weightModal')).hide();
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        console.error('Error saving weight:', error);
    }
}

async function saveTask() {
    const title = document.getElementById('taskTitle').value;
    const category = document.getElementById('taskCategory').value;
    const time = document.getElementById('taskTime').value;
    const priority = document.getElementById('taskPriority').value;
    
    if (!title) {
        showToast('Por favor ingresa un título', 'warning');
        return;
    }
    
    try {
        const response = await makeRequest('/api/tasks', {
            method: 'POST',
            body: JSON.stringify({ 
                title: title,
                category: category,
                due_time: time,
                priority: priority,
                due_date: new Date().toISOString().split('T')[0]
            })
        });
        
        if (response.success) {
            showToast('Tarea creada', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        console.error('Error saving task:', error);
    }
}

async function toggleTask(taskId) {
    try {
        const response = await makeRequest(`/api/tasks/${taskId}`, {
            method: 'PUT',
            body: JSON.stringify({ completed: true })
        });
        
        if (response.success) {
            showToast('Tarea completada', 'success');
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        console.error('Error toggling task:', error);
    }
}

// Funciones para mostrar modales
function showBloodPressureModal() {
    new bootstrap.Modal(document.getElementById('bloodPressureModal')).show();
}

function showWeightModal() {
    new bootstrap.Modal(document.getElementById('weightModal')).show();
}

function showAddTaskModal() {
    new bootstrap.Modal(document.getElementById('addTaskModal')).show();
}

// Auto-refresh cada 5 minutos
setInterval(() => {
    location.reload();
}, 300000);
</script>
{% endblock %}
